module modis35

	use CKD_common

	implicit none
	private
	
	integer, parameter :: ni = 5
	integer, parameter :: nco2 = 5
	integer, parameter :: no3 = 1
	
	public :: ch35, init_ch35
	
contains

	subroutine init_ch35(modis_channel)
	
		type(ckd_type), intent(inout) :: modis_channel
		integer :: all_weights
		
		all_weights = ni*nco2*no3 
		
		modis_channel%num_weights = all_weights
		allocate(modis_channel%weights(all_weights))
		allocate(modis_channel%taus(all_weights, max_layers))
	
	end subroutine init_ch35

      subroutine ch35(u0, p0, t0, ux, fac, u_co2, modis_channel)
!
!      This routine was developed for MODIS Channel 35: 710--725 cm^{-1}
!
!-----------------------------------------------------------------
!     Channel 35   13.78 - 14.08 microns
!-----------------------------------------------------------------
!  INPUTS:
!     u0 --> water vapor amount [g/cm2/km]
!     p0 --> pressure in atmospheres
!     t0 --> temp in K
!	  ux --> ozone (g/cm^2/km)
!     fac --> layer thickness in km
!-----------------------------------------------------------------

		real, dimension(:), intent(in) :: u0, p0, t0, ux, fac
		real, intent(in) :: u_co2
		type(ckd_type), intent(inout) :: modis_channel
		
		integer, parameter :: nlev = max_levels
		integer, parameter :: nlay = max_layers
		integer, parameter :: mlv = nlay

		real :: p(nlay), t(nlay),u(nlay), &
				 uco2(nlay), uo3(nlay)
				
		real :: tau(ni,nlay),tauco2(nco2,nlay), tauo3(no3, nlay), &
				f(ni), fco2(nco2), fo3(no3),  xlog, twin
		
		integer :: i,m,ia,ib, index

		real, parameter :: omega=717.5
	  
      do  m=1,use_layers
        t(m)=(t0(m)+t0(m+1))/2.0
        xlog=(log10(p0(m))+log10(p0(m+1)))/2.0
        p(m)=10.0**xlog
        xlog=(log10(u0(m))+log10(u0(m+1)))/2.0
        u(m)=fac(m)*10.0**xlog
        xlog=(log10(ux(m))+log10(ux(m+1)))/2.0
        uo3(m)=fac(m)*10.0**xlog
        uco2(m)=p(m)*1.01325e+06/(1.3805e-16*t(m))*u_co2*fac(m)* &
     &          1.0e+05/6.023e+23*44.00995
      enddo

      call ck_35(u,f,p,t,tau)
      call ckco2_35(uco2,fco2,p,t,tauco2)
      call cko3_35(uo3,fo3,p,t,tauo3)
	  
      do  m=1,use_layers
        call window_35(omega,u(m),twin,p(m),t(m),fac(m))
         do ia=1,nco2 ! 5 k's for co2
        do i=1,ni ! 5 k's for h2o
			index = (ia-1)*ni + i 
           modis_channel%taus(index, m)=tau(i,m)+twin+tauco2(ia,m)+tauo3(1,m)
 			if (m == 1) modis_channel%weights(index) = f(i)*fco2(ia)*fo3(1)
         end do
        end do
      enddo

	end subroutine ch35

! *********************************************************************
!     h2o 710--725 cm^{-1}
      subroutine ck_35(u,f,p,t,tau)
		real, dimension(:), intent(in) :: p, t, u
		
		real, dimension(:), intent(inout) :: f
		real, dimension(:,:), intent(inout) :: tau
		
		
		real :: k(ni)
		real :: coefk(ni,3,num_pressures)
		integer :: i, jp, jt
      f(1)=0.629977
      f(2)=0.241522
      f(3)=0.078289
      f(4)=0.038619
      f(5)=0.011593
      k(1)=0.00362795
      do i=2,ni
        k(i)=7.0*k(i-1)
      end do
      data ( (coefk(1,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.00000,0.00000,0.00000,0.00000,0.00000,0.00000, &
     & 0.00000,0.00000,0.00000,0.00011,0.00081,0.00308, &
     & 0.01292,0.04665,0.14426,0.35734,0.75088,1.37009, &
     & 2.45694, &
     & 0.000e+00,0.000e+00,0.000e+00,0.000e+00,0.000e+00,0.000e+00, &
     & 0.000e+00,0.000e+00,0.000e+00,3.588e-06,2.836e-05,9.170e-05, &
     & 2.944e-04,1.107e-03,3.475e-03,8.576e-03,1.849e-02,3.485e-02, &
     & 5.695e-02, &
     & 0.000e+00,0.000e+00,0.000e+00,0.000e+00,0.000e+00,0.000e+00, &
     & 0.000e+00,0.000e+00,0.000e+00,3.094e-08,3.128e-07,9.200e-07, &
     & 2.003e-06,9.228e-06,3.000e-05,7.342e-05,1.596e-04,3.262e-04, &
     & 4.797e-04/
      data ( (coefk(2,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.00000,0.00000,0.00000,0.00000,0.00000,0.00000, &
     & 0.00000,0.00023,0.00169,0.00697,0.01841,0.04499, &
     & 0.09619,0.18947,0.31379,0.48619,0.77267,1.28354, &
     & 2.01971, &
     & 0.000e+00,0.000e+00,0.000e+00,0.000e+00,0.000e+00,0.000e+00, &
     & 0.000e+00,7.025e-06,4.764e-05,1.946e-04,5.350e-04,1.216e-03, &
     & 2.706e-03,5.446e-03,9.355e-03,1.415e-02,2.156e-02,3.373e-02, &
     & 5.219e-02, &
     & 0.000e+00,0.000e+00,0.000e+00,0.000e+00,0.000e+00,0.000e+00, &
     & 0.000e+00,7.250e-08,4.147e-07,1.659e-06,5.450e-06,1.162e-05, &
     & 2.745e-05,5.455e-05,9.693e-05,1.481e-04,2.237e-04,3.240e-04, &
     & 4.875e-04/
      data ( (coefk(3,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.00000,0.00000,0.00000,0.00000,0.00000,0.00011, &
     & 0.00078,0.00388,0.01473,0.04137,0.07216,0.11469, &
     & 0.18148,0.27143,0.40580,0.59326,0.85360,1.15927, &
     & 1.40896, &
     & 0.000e+00,0.000e+00,0.000e+00,0.000e+00,0.000e+00,3.662e-06, &
     & 2.229e-05,9.687e-05,3.443e-04,1.182e-03,2.174e-03,3.469e-03, &
     & 5.497e-03,8.155e-03,1.201e-02,1.755e-02,2.487e-02,3.454e-02, &
     & 4.567e-02, &
     & 0.000e+00,0.000e+00,0.000e+00,0.000e+00,0.000e+00,4.094e-08, &
     & 2.047e-07,7.156e-07,2.475e-06,1.140e-05,2.245e-05,3.638e-05, &
     & 5.767e-05,8.502e-05,1.223e-04,1.798e-04,2.459e-04,3.546e-04, &
     & 5.478e-04/
      data ( (coefk(4,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.00000,0.00000,0.00014,0.00073,0.00343,0.00929, &
     & 0.01808,0.03233,0.05110,0.07587,0.11516,0.17299, &
     & 0.25887,0.38058,0.52380,0.67688,0.88635,1.12741, &
     & 1.33064, &
     & 0.000e+00,0.000e+00,7.625e-06,2.049e-05,1.375e-06,2.908e-04, &
     & 5.795e-04,1.007e-03,1.575e-03,2.306e-03,3.426e-03,5.130e-03, &
     & 7.603e-03,1.094e-02,1.579e-02,2.154e-02,2.951e-02,3.794e-02, &
     & 4.453e-02, &
     & 0.000e+00,0.000e+00,1.162e-07,1.728e-07,3.159e-06,2.950e-06, &
     & 6.381e-06,1.060e-05,1.643e-05,2.379e-05,3.429e-05,5.119e-05, &
     & 7.446e-05,1.020e-04,1.598e-04,2.402e-04,3.383e-04,4.251e-04, &
     & 4.802e-04/
      data ( (coefk(5,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.88247,0.89104,0.90701,0.93136,0.96968,1.02307, &
     & 1.09975,1.20068,1.32057,1.44334,1.53452,1.57115, &
     & 1.54257,1.47423,1.37657,1.24863,1.09494,0.90858, &
     & 0.73128, &
     & 3.306e-02,3.324e-02,3.355e-02,3.409e-02,3.498e-02,3.616e-02, &
     & 3.791e-02,4.020e-02,4.309e-02,4.617e-02,4.850e-02,4.965e-02, &
     & 4.898e-02,4.715e-02,4.409e-02,3.944e-02,3.448e-02,2.821e-02, &
     & 2.124e-02, &
     & 4.070e-04,4.080e-04,4.092e-04,4.126e-04,4.187e-04,4.263e-04, &
     & 4.375e-04,4.521e-04,4.725e-04,4.952e-04,5.121e-04,5.225e-04, &
     & 5.179e-04,5.023e-04,4.690e-04,4.086e-04,3.544e-04,2.907e-04, &
     & 2.027e-04/
		call apply_ckd(ni, k, u, f, p, t, tau, coefk, .false.)

      end subroutine ck_35
! *********************************************************************
!     co2 710--725 cm^{-1}
      subroutine ckco2_35(u,f,p,t,tau)
		real, dimension(:), intent(in) :: p, t, u
		
		real, dimension(:), intent(inout) :: f
		real, dimension(:,:), intent(inout) :: tau
		

		real :: k(nco2)
		real :: coefk(nco2,3,num_pressures)
		integer :: i, jp, jt
      f(1)=0.216524
      f(2)=0.445743
      f(3)=0.196934
      f(4)=0.092625
      f(5)=0.048174
      k(1)=0.31824
      do i=2,nco2
        k(i)=7.0*k(i-1)
      end do
      data ( (coefk(1,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.00000,0.00000,0.00000,0.00000,0.00010,0.00051, &
     & 0.00218,0.00681,0.01798,0.05429,0.14793,0.29273, &
     & 0.56989,0.99900,1.83664,3.12153,4.93186,7.53279, &
     & 11.35547, &
     & 0.000e+00,0.000e+00,0.000e+00,0.000e+00,3.562e-06,1.831e-05, &
     & 7.349e-05,2.401e-04,5.646e-04,1.305e-03,3.034e-03,5.815e-03, &
     & 1.034e-02,1.754e-02,3.005e-02,5.002e-02,7.876e-02,1.205e-01, &
     & 1.760e-01, &
     & 0.000e+00,0.000e+00,0.000e+00,0.000e+00,4.344e-08,2.147e-07, &
     & 8.441e-07,2.828e-06,6.209e-06,1.246e-05,2.465e-05,4.611e-05, &
     & 7.105e-05,1.175e-04,1.760e-04,2.678e-04,4.108e-04,6.508e-04, &
     & 9.640e-04/
      data ( (coefk(2,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.00000,0.00007,0.00025,0.00078,0.00214,0.00619, &
     & 0.01751,0.04087,0.07970,0.14438,0.24914,0.40921, &
     & 0.64908,0.99900,1.48285,2.15711,3.06331,4.28587, &
     & 5.88111, &
     & 0.000e+00,2.638e-06,9.125e-06,2.573e-05,6.537e-05,1.731e-04, &
     & 4.636e-04,9.656e-04,1.771e-03,3.057e-03,5.087e-03,8.253e-03, &
     & 1.285e-02,1.938e-02,2.856e-02,4.089e-02,5.625e-02,7.510e-02, &
     & 9.835e-02, &
     & 0.000e+00,3.281e-08,1.081e-07,3.025e-07,7.281e-07,1.791e-06, &
     & 4.466e-06,8.091e-06,1.416e-05,2.323e-05,3.644e-05,5.758e-05, &
     & 8.737e-05,1.256e-04,1.847e-04,2.590e-04,3.513e-04,4.330e-04, &
     & 5.205e-04/
      data ( (coefk(3,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.00046,0.00097,0.00211,0.00476,0.01178,0.02406, &
     & 0.04287,0.07360,0.12363,0.20106,0.31661,0.48207, &
     & 0.70727,0.99900,1.37599,1.82350,2.26452,2.58104, &
     & 2.73191, &
     & 2.105e-05,3.519e-05,6.376e-05,1.363e-04,2.851e-04,5.399e-04, &
     & 9.411e-04,1.562e-03,2.558e-03,4.107e-03,6.385e-03,9.718e-03, &
     & 1.412e-02,1.984e-02,2.650e-02,3.431e-02,4.168e-02,4.715e-02, &
     & 4.899e-02, &
     & 3.019e-07,4.516e-07,6.934e-07,1.488e-06,2.741e-06,4.591e-06, &
     & 7.622e-06,1.168e-05,1.822e-05,2.891e-05,4.372e-05,6.641e-05, &
     & 9.418e-05,1.364e-04,1.743e-04,2.126e-04,2.427e-04,2.740e-04, &
     & 2.825e-04/
      data ( (coefk(4,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.00326,0.00598,0.00983,0.01485,0.02257,0.03528, &
     & 0.05702,0.09255,0.14758,0.22850,0.34879,0.52613, &
     & 0.75403,0.99900,1.19595,1.28271,1.25467,1.20625, &
     & 1.19463, &
     & 1.220e-04,1.412e-04,2.033e-04,2.976e-04,4.423e-04,6.890e-04, &
     & 1.098e-03,1.735e-03,2.682e-03,4.050e-03,6.099e-03,8.865e-03, &
     & 1.252e-02,1.656e-02,2.038e-02,2.248e-02,2.245e-02,2.152e-02, &
     & 2.097e-02, &
     & 1.587e-06,1.275e-06,1.625e-06,2.397e-06,3.319e-06,4.944e-06, &
     & 7.369e-06,1.082e-05,1.544e-05,2.221e-05,3.424e-05,4.477e-05, &
     & 5.972e-05,7.445e-05,9.716e-05,1.148e-04,1.214e-04,1.164e-04, &
     & 1.109e-04/
      data ( (coefk(5,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.55769,0.50635,0.47343,0.46498,0.48486,0.53735, &
     & 0.62364,0.73842,0.86405,0.98327,1.07255,1.10037, &
     & 1.06997,0.99900,0.91481,0.85027,0.81283,0.77739, &
     & 0.73316, &
     & 8.498e-03,7.802e-03,7.441e-03,7.513e-03,8.030e-03,8.961e-03, &
     & 1.032e-02,1.191e-02,1.358e-02,1.519e-02,1.644e-02,1.700e-02, &
     & 1.654e-02,1.524e-02,1.374e-02,1.242e-02,1.150e-02,1.100e-02, &
     & 1.049e-02, &
     & 4.220e-05,4.166e-05,4.194e-05,4.443e-05,4.818e-05,5.171e-05, &
     & 5.541e-05,5.764e-05,6.155e-05,6.501e-05,6.517e-05,6.807e-05, &
     & 6.649e-05,5.916e-05,5.250e-05,4.312e-05,3.364e-05,3.187e-05, &
     & 3.103e-05/
		call apply_ckd(nco2, k, u, f, p, t, tau, coefk, .false.)
      end subroutine ckco2_35
! *********************************************************************
!     o3 710--725 cm^{-1}
      subroutine cko3_35(u,f,p,t,tau)
	
		real, dimension(:), intent(in) :: p, t, u
		
		real, dimension(:), intent(inout) :: f
		real, dimension(:,:), intent(inout) :: tau
		
		
		real :: k(no3)
		integer :: i, m 
      f(1)=1.00000
      do  m=1,use_layers
          k(1)=101.23815*(1.0000-9.0000e-04*(t(m)-250.0)+ &
     &          3.5688e-06*(t(m)-250.0)**2)
          tau(1,m)=k(1)*u(m)
      end do
	  end subroutine cko3_35
!**********************************************************************
      subroutine window_35(omega,u,twin,pres,temp,fac)
		real, intent(in) :: omega, u, pres, temp, fac
		real, intent(inout) :: twin
		
		real :: r, amnt, a1, a2, ph2o, tau 
      r=8.314d+07
!     amnt=u/6.023e+23*2.687e+19*18.01534
      amnt=u
!     write(6,*)u,amnt
!     a1=4.18+5577.8*exp(-.00787*omega)
      a1=4.18+7815.6*exp(-.0083*omega)
      a1=a1*exp(1800.*(1./temp-1./296.))
      a2=0.0008*a1
      ph2o=amnt/(fac*1.0d+05)*r*temp/18.01534/1.01325d+06
      tau=amnt*(a1*ph2o+a2*(pres-ph2o))
!     tau=amnt*(a1*ph2o)
      if(tau.gt.88)then
      twin=88.0
      else
      twin=tau
      end if
	end subroutine window_35
	
end module modis35
