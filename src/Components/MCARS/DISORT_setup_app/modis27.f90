module modis27

	use CKD_common

	implicit none
	private
	
	integer, parameter :: ni = 5
	integer, parameter :: nch4 = 2
	
	public :: ch27, init_ch27
	
contains
	subroutine init_ch27(modis_channel)
	
		type(ckd_type), intent(inout) :: modis_channel
		integer :: all_weights
		
		all_weights = ni*nch4
		
		modis_channel%num_weights = all_weights
		allocate(modis_channel%weights(all_weights))
		allocate(modis_channel%taus(all_weights, max_layers))
	
	end subroutine init_ch27

      subroutine ch27(u0, p0, t0, ux, fac,modis_channel)
!
!      This routine was developed for MODIS Channel 27: 1465--1525 cm^{-1}
!
!-----------------------------------------------------------------
!     Channel 28   6.535 - 6.895 microns
!-----------------------------------------------------------------
!  INPUTS:
!     u0 --> water vapor amount [g/cm2/km]
!     p0 --> pressure in atmospheres
!     t0 --> temp in K
!	  ux --> ozone (g/cm^2/km)
!     fac --> layer thickness in km
!-----------------------------------------------------------------

		real, dimension(:), intent(in) :: u0, p0, t0, ux, fac
		type(ckd_type), intent(inout) :: modis_channel
		
		integer, parameter :: nlev = max_levels
		integer, parameter :: nlay = max_layers
		integer, parameter :: mlv = nlay

		real :: p(nlay), t(nlay),u(nlay), xlog,  &
				  uch4(nlay)
				
		real :: tau(ni,nlay),tauch4(nch4, nlay), &
				 f(ni),  fch4(nch4), twin
		
		integer :: i,m,ia, index
	  
      do  m=1,use_layers
        t(m)=(t0(m)+t0(m+1))/2.0
        p(m)=(p0(m)+p0(m+1))/2.0
        u(m)=fac(m)*(u0(m)+u0(m+1))/2.0
        uch4(m)=p(m)*1.01325e+06/(1.3805e-16*t(m))*1.75e-06*fac(m)* &
            1.0e+05/6.023e+23*16.04303
      enddo

      call ck_27(u,f,p,t,tau)
      call ckch4_27(uch4,fch4,p,t,tauch4)
	  	  
      do  m=1,use_layers
        call window_27(u(m),twin,p(m),t(m),fac(m))
			  do ia=1,nch4 ! 2 k's for ch4
			do i=1,ni   ! 5 k's for h2o
				index = (ia-1)*ni + i
				modis_channel%taus(index,m)=tau(i,m)+twin+tauch4(ia,m)
 			if (m == 1) modis_channel%weights(index) = f(i)*fch4(ia)
			  end do
			end do
        enddo


	  end subroutine ch27

! *********************************************************************
      subroutine ck_27(u,f,p,t,tau)
		real, dimension(:), intent(in) :: p, t, u
		
		real, dimension(:), intent(inout) :: f
		real, dimension(:,:), intent(inout) :: tau
		
		

		real :: k(ni)
		real :: coefk(ni,3,num_pressures)
		integer :: i, jp, jt

      f(1)=0.297851
      f(2)=0.386524
      f(3)=0.202789
      f(4)=0.090890
      f(5)=0.021946
      k(1)=14.713
      do i=2,ni
        k(i)=6.0*k(i-1)
      end do
      data ( (coefk(1,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.00000,0.00000,0.00000,0.00000,0.00000,0.00000, &
     & 0.00000,0.00000,0.00009,0.00040,0.00147,0.00584, &
     & 0.03170,0.10356,0.23025,0.45221,0.78441,1.27832, &
     & 2.00203, &
     & 0.000e+00,0.000e+00,0.000e+00,0.000e+00,0.000e+00,0.000e+00, &
     & 0.000e+00,0.000e+00,9.625e-07,3.200e-06,1.088e-05,3.150e-05, &
     & 4.588e-05,2.530e-04,3.939e-04,6.023e-04,9.278e-04,1.058e-03, &
     & 1.360e-03, &
     & 0.000e+00,0.000e+00,0.000e+00,0.000e+00,0.000e+00,0.000e+00, &
     & 0.000e+00,0.000e+00,2.812e-09,1.875e-08,8.437e-08,1.250e-07, &
     & -4.844e-07,5.750e-07,-3.906e-07,-2.063e-07,-1.725e-06,-6.966e-06, &
     & -4.791e-06/
      data ( (coefk(2,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.00000,0.00000,0.00000,0.00000,0.00000,0.00003, &
     & 0.00011,0.00035,0.00125,0.00554,0.02214,0.05805, &
     & 0.11117,0.19088,0.31461,0.50317,0.79662,1.24557, &
     & 1.88321, &
     & 0.000e+00,0.000e+00,0.000e+00,0.000e+00,0.000e+00,3.000e-07, &
     & 1.100e-06,3.350e-06,9.425e-06,3.100e-05,8.925e-05,1.885e-04, &
     & 3.304e-04,4.801e-04,7.479e-04,1.119e-03,1.590e-03,2.453e-03, &
     & 3.762e-03, &
     & 0.000e+00,0.000e+00,0.000e+00,0.000e+00,0.000e+00,6.250e-10, &
     & 4.375e-09,1.562e-08,4.438e-08,1.000e-07,-4.375e-08,-2.625e-07, &
     & -2.719e-07,-8.969e-07,-1.366e-06,-2.816e-06,-5.653e-06,-1.026e-05, &
     & -1.139e-05/
      data ( (coefk(3,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.00000,0.00000,0.00000,0.00006,0.00017,0.00051, &
     & 0.00159,0.00505,0.01302,0.02697,0.04796,0.08137, &
     & 0.13541,0.21888,0.34792,0.54498,0.82650,1.18888, &
     & 1.59935, &
     & 0.000e+00,0.000e+00,0.000e+00,9.750e-07,2.625e-06,6.637e-06, &
     & 1.687e-05,4.000e-05,7.213e-05,1.145e-04,1.779e-04,2.661e-04, &
     & 3.935e-04,5.769e-04,8.729e-04,1.298e-03,1.922e-03,2.697e-03, &
     & 3.402e-03, &
     & 0.000e+00,0.000e+00,0.000e+00,8.125e-09,2.000e-08,4.031e-08, &
     & 7.188e-08,8.750e-08,5.312e-08,5.625e-08,1.094e-07,1.594e-07, &
     & -2.625e-07,-1.103e-06,-1.959e-06,-4.087e-06,-6.459e-06,-8.894e-06, &
     & -1.047e-05/
      data ( (coefk(4,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.00246,0.00246,0.00311,0.00514,0.00859,0.01329, &
     & 0.01933,0.02783,0.04139,0.06431,0.10370,0.16913, &
     & 0.26661,0.39946,0.56675,0.75634,0.93173,1.04301, &
     & 1.06001, &
     & 4.800e-05,4.838e-05,4.487e-05,6.012e-05,7.788e-05,9.837e-05, &
     & 1.221e-04,1.518e-04,2.000e-04,2.691e-04,3.884e-04,5.569e-04, &
     & 7.932e-04,1.066e-03,1.375e-03,1.698e-03,1.994e-03,2.037e-03, &
     & 1.790e-03, &
     & 3.062e-07,3.156e-07,3.469e-07,3.344e-07,3.156e-07,2.531e-07, &
     & 3.344e-07,4.750e-07,4.312e-07,3.531e-07,3.094e-07,-9.281e-07, &
     & -1.231e-06,-1.737e-06,-3.131e-06,-6.206e-06,-8.928e-06,-5.366e-06, &
     & -8.937e-07/
      data ( (coefk(5,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 1.90816,1.84457,1.75917,1.65622,1.54098,1.42893, &
     & 1.33742,1.28496,1.28650,1.34455,1.44092,1.53280, &
     & 1.57273,1.54082,1.44310,1.28467,1.09443,0.89731, &
     & 0.70478, &
     & 3.875e-03,4.011e-03,4.090e-03,4.167e-03,4.176e-03,4.055e-03, &
     & 3.809e-03,3.580e-03,3.440e-03,3.349e-03,3.314e-03,3.256e-03, &
     & 3.036e-03,2.821e-03,2.590e-03,2.148e-03,1.596e-03,1.321e-03, &
     & 1.208e-03, &
     & -1.338e-05,-1.319e-05,-1.115e-05,-1.143e-05,-8.828e-06,-7.228e-06, &
     & -6.156e-06,-5.553e-06,-6.625e-06,-8.266e-06,-1.015e-05,-1.160e-05, &
     & -1.164e-05,-1.342e-05,-1.228e-05,-9.031e-06,-6.634e-06,-9.219e-06, &
     & -6.122e-06/

		call apply_ckd(ni, k, u, f, p, t, tau, coefk, .false.)

      end subroutine ck_27
! *********************************************************************
      subroutine window_27 (amnt,twin,patm,temp,fac)
!     Parameterization of CKD_2.4 continuum over 1465 to 1525 cm-1 band
!     Fit inaccurate for amnt < 0.01 g/cm*2;
!          however optical depths < 0.001.
!     INPUT:
!     amnt = h2O layer amount (g/cm**2)
!     patm= pressure (atm)
!     temp = temperature (k)
!     OUTPUT:
!     twin = parameterized CKD_2.4 optical depth over band
!
	  real, intent(in) :: amnt, patm, temp, fac
	  real, intent(inout) :: twin

      integer, parameter :: ncoef=7

      real ::  aa(ncoef), ph2o, tau_log
!
      data aa/0.000,1.200,-0.007957,1.5260,60.300,4.004e-01,-0.4720/
!
      ph2o = amnt*(8.314e+07*temp)/(fac*1.0e+05*18.01534*1.01325e+06)
!
          tau_log   = aa(1)              + &
     &                 aa(2) * log(amnt)  + &
     &                 aa(3) * temp       + &
     &                 aa(4) * patm       + &
     &                 aa(5) * ph2o       + &
     &                 aa(6) * amnt       + &
     &                 aa(7) * log(ph2o)

        twin = exp ( tau_log )
!
        end subroutine window_27
! *********************************************************************
!     ch4 1465--1525 cm^{-1}
      subroutine ckch4_27(u,f,p,t,tau)
		real, dimension(:), intent(in) :: p, t, u
		
		real, dimension(:), intent(inout) :: f
		real, dimension(:,:), intent(inout) :: tau

		real :: k(nch4)
		real :: coefk(nch4,3,num_pressures)
		integer :: i, jp, jt
      f(1)=0.979793
      f(2)=0.020207
      k(1)=1.5798107
      do i=2,nch4
        k(i)=100.0*k(i-1)
      end do
      data ( (coefk(1,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.07662,0.07742,0.07863,0.08399,0.09193,0.10296, &
     & 0.11738,0.13693,0.16310,0.19782,0.24424,0.30635, &
     & 0.38710,0.48565,0.60605,0.75596,0.91768,1.10188, &
     & 1.30006, &
     & 1.236e-03,1.236e-03,1.213e-03,1.181e-03,1.171e-03,1.173e-03, &
     & 1.186e-03,1.198e-03,1.220e-03,1.260e-03,1.278e-03,1.308e-03, &
     & 1.297e-03,1.248e-03,9.826e-04,6.148e-04,1.703e-04,-3.380e-04, &
     & -6.929e-04, &
     & 7.678e-06,7.653e-06,8.175e-06,7.812e-06,7.819e-06,7.622e-06, &
     & 8.013e-06,8.219e-06,8.819e-06,9.559e-06,1.068e-05,1.178e-05, &
     & 1.197e-05,1.428e-05,1.755e-05,1.962e-05,2.153e-05,2.261e-05, &
     & 2.235e-05/
      data ( (coefk(2,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 1.47148,1.46985,1.46731,1.46369,1.46001,1.45410, &
     & 1.44754,1.43748,1.42305,1.40650,1.38270,1.35340, &
     & 1.31289,1.26448,1.20577,1.13205,1.04655,0.95867, &
     & 0.86058, &
     & -6.625e-04,-6.536e-04,-6.425e-04,-6.498e-04,-6.339e-04,-6.245e-04, &
     & -5.981e-04,-5.880e-04,-5.838e-04,-5.934e-04,-5.941e-04,-5.654e-04, &
     & -5.608e-04,-5.492e-04,-4.211e-04,-2.414e-04,-7.163e-05, 2.075e-04, &
     &  3.825e-04, &
     & -6.813e-07,-7.218e-07,-7.187e-07,-2.875e-07,-3.782e-07,-3.500e-07, &
     & -1.309e-06,-1.600e-06,-1.125e-06,-2.766e-06,-2.528e-06,-3.947e-06, &
     & -3.869e-06,-5.169e-06,-7.003e-06,-7.884e-06,-8.003e-06,-9.194e-06, &
     & -8.394e-06/
		call apply_ckd(nch4, k, u, f, p, t, tau, coefk, .false.)

      end subroutine ckch4_27
	  
end module modis27
