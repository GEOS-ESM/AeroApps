module modis26 

	use CKD_common

	implicit none
	private
	
	integer, parameter :: ni = 5
	
	public :: ch26, init_ch26

contains
	subroutine init_ch26(modis_channel)
	
		type(ckd_type), intent(inout) :: modis_channel
		integer :: all_weights
		
		all_weights = ni
		
		modis_channel%num_weights = all_weights
		allocate(modis_channel%weights(all_weights))
		allocate(modis_channel%taus(all_weights, max_layers))
	
	end subroutine init_ch26

      subroutine ch26(u0, p0, t0, ux, fac, modis_channel)
!
!      This routine was developed for MODIS Band 26
!                        870--950 cm^{-1}
!
!-----------------------------------------------------------------
!      Channel 26   1.36-1.39 microns
!-----------------------------------------------------------------
!  INPUTS:
!     u0 --> water vapor amount [g/cm2/km]
!     p0 --> pressure in atmospheres
!     t0 --> temp in K
!     ux --> ozone [g/cm2/km]
!     dz --> layer thickness in km
!-----------------------------------------------------------------

		real, dimension(:), intent(in) :: u0, p0, t0, ux, fac
		type(ckd_type), intent(inout) :: modis_channel
		
		integer, parameter :: nlev = max_levels
		integer, parameter :: nlay = max_layers
		integer, parameter :: mlv = nlay

		real :: p(nlay), t(nlay),u(nlay)				
		real :: tau(ni,nlay), f(ni)
		
		integer :: i,m
		real :: xlog


      do  m=1,use_layers
        t(m)=(t0(m)+t0(m+1))/2.0
        xlog=(log10(p0(m))+log10(p0(m+1)))/2.0
        p(m)=10.0**xlog
        xlog=(log10(u0(m))+log10(u0(m+1)))/2.0
        u(m)=fac(m)*10.0**xlog
      enddo

      call ck26(u,f,p,t,tau)
	  
	  
      do  m=1,use_layers
        do i=1,ni ! 5 k for h2o
            modis_channel%taus(i,m)=tau(i,m)
 			if (m == 1) modis_channel%weights(i) = f(i)
          end do
        end do
	  
	end subroutine ch26
	
! *********************************************************************
      subroutine ck26(u,f,p,t,tau)
		real, dimension(:), intent(in) :: p, t, u
		
		real, dimension(:), intent(inout) :: f
		real, dimension(:,:), intent(inout) :: tau
		
		
		
		real :: k(ni)
		real :: coefk(ni,3,num_pressures)
		integer :: i, jp, jt

      f(1)=0.320587
      f(2)=0.395933
      f(3)=0.196203
      f(4)=0.070818
      f(5)=0.016459
      k(1)=1.5957358
      do i=2,ni
        k(i)=6.0*k(i-1)
      end do
      data ( (coefk(1,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.00000,0.00000,0.00000,0.00000,0.00000,0.00000, &
     & 0.00000,0.00000,0.00005,0.00049,0.00317,0.01519, &
     & 0.05201,0.12504,0.24907,0.45647,0.77769,1.27839, &
     &  2.03805, &
     &  0.000E+00, 0.000E+00, 0.000E+00, 0.000E+00, 0.000E+00, 0.000E+00, &
     &  0.000E+00, 0.000E+00, 2.500E-07, 3.125E-06, 1.200E-05, 2.025E-05, &
     & -2.213E-05,-1.206E-04,-3.361E-04,-8.470E-04,-1.485E-03,-2.515E-03, &
     & -4.212E-03, &
     &  0.000E+00, 0.000E+00, 0.000E+00, 0.000E+00, 0.000E+00, 0.000E+00, &
     &  0.000E+00, 0.000E+00,-6.250E-09,-3.125E-09,-1.875E-08,-3.125E-08, &
     &  3.126E-09, 8.469E-07, 7.031E-07, 3.000E-06, 5.306E-06, 6.925E-06, &
     &  1.162E-05/
      data ( (coefk(2,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.00000,0.00000,0.00000,0.00000,0.00000,0.00002, &
     & 0.00018,0.00107,0.00445,0.01356,0.03379,0.07018, &
     & 0.12481,0.20683,0.33368,0.52800,0.81296,1.22770, &
     &  1.79604, &
     &  0.000E+00, 0.000E+00, 0.000E+00, 0.000E+00, 0.000E+00, 5.000E-07, &
     &  1.750E-06, 7.250E-06, 1.875E-05, 2.588E-05, 6.375E-06,-4.875E-05, &
     & -1.486E-04,-2.975E-04,-6.035E-04,-1.047E-03,-1.734E-03,-2.769E-03, &
     & -4.147E-03, &
     &  0.000E+00, 0.000E+00, 0.000E+00, 0.000E+00, 0.000E+00, 6.250E-09, &
     &  2.274E-15, 0.000E+00,-1.250E-08,-5.312E-08, 1.969E-07, 3.188E-07, &
     &  7.969E-07, 1.169E-06, 2.244E-06, 2.694E-06, 4.700E-06, 7.528E-06, &
     &  1.093E-05/
      data ( (coefk(3,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.00388,0.00415,0.00448,0.00488,0.00539,0.00644, &
     & 0.01287,0.02349,0.03981,0.06203,0.09271,0.13705, &
     & 0.20323,0.30129,0.44092,0.63351,0.86979,1.13928, &
     &  1.41655, &
     &  7.325E-05, 7.613E-05, 8.012E-05, 8.525E-05, 9.187E-05, 8.200E-05, &
     &  8.088E-05, 8.125E-05, 5.825E-05, 3.112E-05,-1.762E-05,-1.009E-04, &
     & -2.347E-04,-4.270E-04,-7.725E-04,-1.264E-03,-1.802E-03,-2.407E-03, &
     & -2.947E-03, &
     &  4.125E-07, 4.031E-07, 4.094E-07, 4.188E-07, 4.344E-07, 6.562E-07, &
     &  2.969E-07, 2.750E-07, 2.875E-07, 2.969E-07, 4.094E-07, 3.469E-07, &
     &  5.313E-07, 7.687E-07, 1.744E-06, 2.903E-06, 3.144E-06, 5.100E-06, &
     &  4.875E-06/
      data ( (coefk(4,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.15768,0.15830,0.15960,0.16136,0.16439,0.16945, &
     & 0.17996,0.19545,0.21778,0.25122,0.29925,0.36659, &
     & 0.45762,0.57201,0.70378,0.84127,0.95411,1.03818, &
     &  1.06392, &
     &  9.837E-04, 9.760E-04, 9.713E-04, 9.585E-04, 9.404E-04, 8.906E-04, &
     &  8.126E-04, 7.130E-04, 5.851E-04, 4.194E-04, 2.271E-04,-5.800E-05, &
     & -4.319E-04,-8.516E-04,-1.265E-03,-1.659E-03,-1.921E-03,-1.972E-03, &
     & -1.865E-03, &
     & -1.431E-06,-1.369E-06,-1.431E-06,-1.300E-06,-1.334E-06,-8.281E-07, &
     & -7.531E-07,-7.125E-07,-3.281E-07,-3.781E-07, 1.469E-07, 5.875E-07, &
     &  1.634E-06, 2.028E-06, 1.994E-06, 2.944E-06, 4.394E-06, 1.884E-06, &
     &  4.303E-06/
      data ( (coefk(5,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 2.08635,2.08293,2.08103,2.07360,2.06445,2.05042, &
     & 2.03010,2.00160,1.95793,1.90456,1.83928,1.76732, &
     & 1.68374,1.58305,1.45334,1.28855,1.09495,0.90379, &
     &  0.72777, &
     & -4.771E-03,-4.790E-03,-4.719E-03,-4.699E-03,-4.635E-03,-4.527E-03, &
     & -4.395E-03,-4.198E-03,-3.938E-03,-3.700E-03,-3.451E-03,-3.363E-03, &
     & -3.219E-03,-2.986E-03,-2.677E-03,-2.261E-03,-1.830E-03,-1.514E-03, &
     & -1.168E-03, &
     &  8.359E-06, 9.087E-06, 7.531E-06, 8.859E-06, 8.016E-06, 7.763E-06, &
     &  7.453E-06, 5.000E-06, 5.897E-06, 4.331E-06, 6.672E-06, 5.216E-06, &
     &  6.122E-06, 5.109E-06, 5.019E-06, 4.016E-06, 3.378E-06, 3.822E-06, &
     &  2.050E-06/
		call apply_ckd(ni, k, u, f, p, t, tau, coefk, .false.)
      end subroutine ck26
	  
end module modis26
