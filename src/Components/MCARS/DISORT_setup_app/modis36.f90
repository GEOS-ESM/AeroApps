module modis36

	use CKD_common

	implicit none
	private
	
	integer, parameter :: ni = 6
	integer, parameter :: nco2 = 5
	integer, parameter :: no3 = 1
	integer, parameter :: nn2o = 1
	
	public :: ch36, init_ch36
	
contains
	subroutine init_ch36(modis_channel)
	
		type(ckd_type), intent(inout) :: modis_channel
		integer :: all_weights
		
		all_weights = ni*nco2*no3*nn2o 
		
		modis_channel%num_weights = all_weights
		allocate(modis_channel%weights(all_weights))
		allocate(modis_channel%taus(all_weights, max_layers))
	
	end subroutine init_ch36

      subroutine ch36(u0, p0, t0, ux, fac, u_co2, modis_channel)
!
!      This routine was developed for MODIS Channel 36: 695--710 cm^{-1}
!
!-----------------------------------------------------------------
!     Channel 36   14.08 - 14.38 microns
!-----------------------------------------------------------------
!  INPUTS:
!     u0 --> water vapor amount [g/cm2/km]
!     p0 --> pressure in atmospheres
!     t0 --> temp in K
!	  ux --> ozone (g/cm^2/km)
!     fac --> layer thickness in km
!-----------------------------------------------------------------

		real, dimension(:), intent(in) :: u0, p0, t0, ux, fac
		real, intent(in) :: u_co2
		type(ckd_type), intent(inout) :: modis_channel
		
		integer, parameter :: nlev = max_levels
		integer, parameter :: nlay = max_layers
		integer, parameter :: mlv = nlay

		real :: p(nlay), t(nlay),u(nlay), &
				 uco2(nlay), uo3(nlay), un2o(nlay)
				
		real :: tau(ni,nlay),tauco2(nco2,nlay), tauo3(no3, nlay), taun2o(nn2o, nlay), &
				f(ni), fco2(nco2), fo3(no3), fn2o(nn2o), xlog, twin
		
		integer :: i,m,ia,ib, index


		real, parameter :: omega=702.5
	  
      do  m=1,use_layers
        t(m)=(t0(m)+t0(m+1))/2.0
        xlog=(log10(p0(m))+log10(p0(m+1)))/2.0
        p(m)=10.0**xlog
        xlog=(log10(u0(m))+log10(u0(m+1)))/2.0
        u(m)=fac(m)*10.0**xlog
        xlog=(log10(ux(m))+log10(ux(m+1)))/2.0
        uo3(m)=fac(m)*10.0**xlog
        uco2(m)=p(m)*1.01325e+06/(1.3805e-16*t(m))*u_co2*fac(m)* &
     &          1.0e+05/6.023e+23*44.00995
        un2o(m)=p(m)*1.01325e+06/(1.3805e-16*t(m))*2.80e-07*fac(m)* &
     &          1.0e+05/6.023e+23*44.0128
      enddo
	  
      call ck_36(u,f,p,t,tau)
      call ckco2_36(uco2,fco2,p,t,tauco2)
      call ckn2o_36(un2o,fn2o,p,t,taun2o)
      call cko3_36(uo3,fo3,p,t,tauo3)
	  
	  
      do  m=1,use_layers
        call window_36(omega,u(m),twin,p(m),t(m),fac(m))
         do ia=1,nco2 ! 5 k's for co2
        do i=1,ni ! 6 k's for h2o
			index = (ia-1)*ni + i 
             modis_channel%taus(index,m)=tau(i,m)+twin+tauco2(ia,m)+ &
     &                       taun2o(1,m)+tauo3(1,m)
 			if (m == 1) modis_channel%weights(index) = f(i)*fco2(ia)*fn2o(1)*fo3(1)
         end do
        end do
      enddo


	end subroutine ch36

! *********************************************************************
!     h2o 695--710 cm^{-1}
      subroutine ck_36(u,f,p,t,tau)
		real, dimension(:), intent(in) :: p, t, u
		
		real, dimension(:), intent(inout) :: f
		real, dimension(:,:), intent(inout) :: tau
		
		
		real :: k(ni)
		real :: coefk(ni,3,num_pressures)
		integer :: i, jp, jt
      f(1)=0.253456
      f(2)=0.353863
      f(3)=0.247385
      f(4)=0.078079
      f(5)=0.049575
      f(6)=0.017642
      k(1)=0.016077066
      do i=2,ni
        k(i)=5.0*k(i-1)
      end do
      data ( (coefk(1,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.00000,0.00000,0.00000,0.00000,0.00000,0.00000, &
     & 0.00000,0.00000,0.00000,0.00000,0.00000,0.00003, &
     & 0.00078,0.00513,0.06647,0.27107,0.69759,1.34723, &
     & 2.18111, &
     & 0.000E+00,0.000E+00,0.000E+00,0.000E+00,0.000E+00,0.000E+00, &
     & 0.000E+00,0.000E+00,0.000E+00,0.000E+00,0.000E+00,7.000E-07, &
     & 2.681E-05,1.575E-04,1.387E-03,5.197E-03,1.379E-02,2.744E-02, &
     & 4.490E-02, &
     & 0.000E+00,0.000E+00,0.000E+00,0.000E+00,0.000E+00,0.000E+00, &
     & 0.000E+00,0.000E+00,0.000E+00,0.000E+00,0.000E+00,4.375E-09, &
     & 2.903E-07,1.900E-06,8.022E-06,2.775E-05,7.518E-05,1.703E-04, &
     & 2.874E-04/
      data ( (coefk(2,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.00000,0.00000,0.00000,0.00000,0.00000,0.00000, &
     & 0.00000,0.00000,0.00000,0.00007,0.00041,0.00351, &
     & 0.05106,0.16019,0.29338,0.49028,0.79254,1.26640, &
     & 2.01084, &
     & 0.000E+00,0.000E+00,0.000E+00,0.000E+00,0.000E+00,0.000E+00, &
     & 0.000E+00,0.000E+00,0.000E+00,2.087E-06,1.039E-05,5.687E-05, &
     & 8.661E-04,2.853E-03,5.758E-03,9.548E-03,1.552E-02,2.505E-02, &
     & 3.974E-02, &
     & 0.000E+00,0.000E+00,0.000E+00,0.000E+00,0.000E+00,0.000E+00, &
     & 0.000E+00,0.000E+00,0.000E+00,2.219E-08,1.003E-07,8.437E-08, &
     & 2.747E-06,1.207E-05,3.263E-05,5.263E-05,8.755E-05,1.442E-04, &
     & 2.294E-04/
      data ( (coefk(3,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.00000,0.00000,0.00000,0.00000,0.00000,0.00000, &
     & 0.00000,0.00010,0.00053,0.00385,0.02606,0.06940, &
     & 0.12300,0.19554,0.31362,0.49714,0.79048,1.27000, &
     & 1.99133, &
     & 0.000E+00,0.000E+00,0.000E+00,0.000E+00,0.000E+00,0.000E+00, &
     & 0.000E+00,2.475E-06,1.078E-05,7.950E-05,5.091E-04,1.365E-03, &
     & 2.479E-03,3.951E-03,6.294E-03,9.968E-03,1.568E-02,2.518E-02, &
     & 4.015E-02, &
     & 0.000E+00,0.000E+00,0.000E+00,0.000E+00,0.000E+00,0.000E+00, &
     & 0.000E+00,2.125E-08,7.812E-08,4.437E-07,2.897E-06,8.025E-06, &
     & 1.572E-05,2.520E-05,3.960E-05,6.276E-05,9.557E-05,1.515E-04, &
     & 2.467E-04/
      data ( (coefk(4,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.00000,0.00000,0.00000,0.00000,0.00000,0.00004, &
     & 0.00023,0.00134,0.01213,0.03509,0.05952,0.09082, &
     & 0.13788,0.21189,0.33137,0.52121,0.81171,1.22556, &
     & 1.70982, &
     & 0.000E+00,0.000E+00,0.000E+00,0.000E+00,0.000E+00,1.013E-06, &
     & 5.088E-06,2.610E-05,2.251E-04,6.849E-04,1.182E-03,1.808E-03, &
     & 2.720E-03,4.124E-03,6.373E-03,1.011E-02,1.594E-02,2.469E-02, &
     & 3.584E-02, &
     & 0.000E+00,0.000E+00,0.000E+00,0.000E+00,0.000E+00,1.031E-08, &
     & 3.781E-08,1.394E-07,9.719E-07,3.816E-06,6.984E-06,1.099E-05, &
     & 1.637E-05,2.402E-05,3.553E-05,5.723E-05,9.126E-05,1.454E-04, &
     & 2.324E-04/
      data ( (coefk(5,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.00000,0.00000,0.00000,0.00010,0.00084,0.00444, &
     & 0.01173,0.02265,0.03668,0.05581,0.08436,0.12827, &
     & 0.19665,0.30517,0.46575,0.67685,0.90532,1.06714, &
     & 1.11526, &
     & 0.000E+00,0.000E+00,0.000E+00,3.288E-06,2.171E-05,9.787E-05, &
     & 2.505E-04,4.755E-04,7.690E-04,1.139E-03,1.711E-03,2.558E-03, &
     & 3.939E-03,6.091E-03,9.380E-03,1.398E-02,1.892E-02,2.260E-02, &
     & 2.410E-02, &
     & 0.000E+00,0.000E+00,0.000E+00,5.156E-08,1.559E-07,6.219E-07, &
     & 1.637E-06,3.219E-06,5.244E-06,7.184E-06,1.068E-05,1.539E-05, &
     & 2.427E-05,3.683E-05,5.657E-05,8.928E-05,1.228E-04,1.523E-04, &
     & 1.680E-04/
      data ( (coefk(6,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.87922,0.88885,0.90669,0.93468,0.97776,1.03852, &
     & 1.12357,1.23646,1.37306,1.51763,1.64186,1.71151, &
     & 1.70951,1.64133,1.51747,1.33956,1.11388,0.88682, &
     & 0.65877, &
     & 2.219E-02,2.233E-02,2.256E-02,2.299E-02,2.362E-02,2.456E-02, &
     & 2.591E-02,2.780E-02,3.024E-02,3.305E-02,3.580E-02,3.780E-02, &
     & 3.833E-02,3.745E-02,3.519E-02,3.158E-02,2.679E-02,2.216E-02, &
     & 1.727E-02, &
     & 1.882E-04,1.887E-04,1.892E-04,1.914E-04,1.934E-04,1.978E-04, &
     & 2.045E-04,2.142E-04,2.284E-04,2.461E-04,2.652E-04,2.844E-04, &
     & 2.934E-04,2.946E-04,2.847E-04,2.626E-04,2.299E-04,2.012E-04, &
     & 1.692E-04/
		call apply_ckd(ni, k, u, f, p, t, tau, coefk, .false.)

      end subroutine ck_36
! *********************************************************************
!     co2 695--710 cm^{-1}
      subroutine ckco2_36(u,f,p,t,tau)
		real, dimension(:), intent(in) :: p, t, u
		
		real, dimension(:), intent(inout) :: f
		real, dimension(:,:), intent(inout) :: tau
		
		real :: k(nco2)
		real :: coefk(nco2,3,num_pressures)
		integer :: i, jp, jt
      f(1)=0.330294
      f(2)=0.443173
      f(3)=0.144970
      f(4)=0.062467
      f(5)=0.019096
      k(1)=13.94915
      do i=2,nco2
        k(i)=4.0*k(i-1)
      end do
      data ( (coefk(1,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.00000,0.00000,0.00000,0.00000,0.00000,0.00006, &
     & 0.00021,0.00078,0.00334,0.01185,0.02903,0.06417, &
     & 0.11945,0.19703,0.32247,0.51585,0.81085,1.23311, &
     & 1.83375, &
     & 0.000E+00,0.000E+00,0.000E+00,0.000E+00,0.000E+00,1.875E-06, &
     & 5.737E-06,2.017E-05,6.475E-05,2.085E-04,4.865E-04,9.179E-04, &
     & 1.759E-03,2.923E-03,4.741E-03,7.567E-03,1.194E-02,1.826E-02, &
     & 2.656E-02, &
     & 0.000E+00,0.000E+00,0.000E+00,0.000E+00,0.000E+00,2.187E-08, &
     & 5.719E-08,1.944E-07,4.375E-07,1.131E-06,2.450E-06,3.166E-06, &
     & 5.597E-06,1.006E-05,1.513E-05,2.377E-05,3.764E-05,6.687E-05, &
     & 9.690E-05/
      data ( (coefk(2,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.00000,0.00000,0.00007,0.00016,0.00043,0.00120, &
     & 0.00320,0.00841,0.01879,0.03509,0.06123,0.10369, &
     & 0.17004,0.26928,0.40821,0.60253,0.85739,1.15238, &
     & 1.47145, &
     & 0.000E+00,0.000E+00,1.988E-06,4.375E-06,1.069E-05,2.806E-05, &
     & 6.862E-05,1.616E-04,3.234E-04,5.684E-04,9.348E-04,1.523E-03, &
     & 2.428E-03,3.828E-03,5.793E-03,8.354E-03,1.163E-02,1.525E-02, &
     & 1.864E-02, &
     & 0.000E+00,0.000E+00,2.281E-08,4.437E-08,9.781E-08,2.453E-07, &
     & 5.281E-07,9.969E-07,1.672E-06,2.816E-06,4.219E-06,6.106E-06, &
     & 9.050E-06,1.344E-05,2.231E-05,3.135E-05,4.150E-05,4.966E-05, &
     & 6.214E-05/
      data ( (coefk(3,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.00031,0.00056,0.00112,0.00221,0.00434,0.00863, &
     & 0.01626,0.02751,0.04440,0.07165,0.11790,0.18900, &
     & 0.29053,0.42920,0.59335,0.75453,0.91014,1.10383, &
     & 1.31996, &
     & 1.161E-05,1.775E-05,3.100E-05,5.444E-05,9.337E-05,1.714E-04, &
     & 2.895E-04,4.588E-04,6.996E-04,1.079E-03,1.717E-03,2.742E-03, &
     & 4.131E-03,5.919E-03,8.014E-03,1.013E-02,1.141E-02,1.279E-02, &
     & 1.463E-02, &
     & 1.466E-07,2.044E-07,3.150E-07,5.203E-07,7.656E-07,1.259E-06, &
     & 1.781E-06,2.463E-06,3.216E-06,4.538E-06,6.422E-06,1.086E-05, &
     & 1.669E-05,2.206E-05,2.632E-05,3.446E-05,3.547E-05,3.419E-05, &
     & 3.085E-05/
      data ( (coefk(4,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 0.00498,0.00646,0.00880,0.01206,0.01719,0.02535, &
     & 0.03910,0.06192,0.09822,0.15597,0.23867,0.34382, &
     & 0.45781,0.57962,0.71258,0.85319,0.97139,1.00963, &
     & 0.96821, &
     & 1.142E-04,1.252E-04,1.519E-04,1.885E-04,2.610E-04,3.909E-04, &
     & 6.144E-04,9.869E-04,1.535E-03,2.320E-03,3.475E-03,4.812E-03, &
     & 6.131E-03,7.103E-03,8.068E-03,9.024E-03,1.002E-02,1.029E-02, &
     & 9.715E-03, &
     & 9.812E-07,9.875E-07,1.084E-06,1.125E-06,1.475E-06,2.109E-06, &
     & 3.047E-06,4.816E-06,7.356E-06,9.722E-06,1.474E-05,1.878E-05, &
     & 2.293E-05,2.114E-05,1.971E-05,1.572E-05,1.301E-05,1.290E-05, &
     & 1.206E-05/
      data ( (coefk(5,jt,jp), jp = 1, 19), jt = 1, 3)/ &
     & 1.02761,0.95149,0.89114,0.86554,0.89447,0.99180, &
     & 1.15917,1.37512,1.61000,1.79698,1.92358,1.98252, &
     & 1.97144,1.85823,1.65759,1.40460,1.13310,0.86922, &
     & 0.64375, &
     & 1.379E-02,1.239E-02,1.146E-02,1.117E-02,1.164E-02,1.289E-02, &
     & 1.468E-02,1.671E-02,1.857E-02,2.006E-02,2.074E-02,2.064E-02, &
     & 2.003E-02,1.892E-02,1.660E-02,1.395E-02,1.111E-02,8.457E-03, &
     & 6.214E-03, &
     & 4.259E-05,4.110E-05,4.246E-05,4.636E-05,5.013E-05,5.262E-05, &
     & 5.172E-05,4.858E-05,4.103E-05,4.482E-05,3.982E-05,3.116E-05, &
     & 2.144E-05,2.443E-05,1.960E-05,1.637E-05,1.092E-05,8.869E-06, &
     & 5.991E-06/
		call apply_ckd(nco2, k, u, f, p, t, tau, coefk, .false.)
      end subroutine ckco2_36
! *********************************************************************
!     n2o 695--710 cm^{-1}
      subroutine ckn2o_36(u,f,p,t,tau)
	
		real, dimension(:), intent(in) :: p, t, u
		
		real, dimension(:), intent(inout) :: f
		real, dimension(:,:), intent(inout) :: tau
		
		
		real :: k(nn2o)
		integer :: i, m 
      f(1)=1.00000
      do  m=1,use_layers
          k(1)=0.68309438*(1.0000+1.0974e-02*(t(m)-250.0)+ &
     &          1.0870e-05*(t(m)-250.0)**2)
          tau(1,m)=k(1)*u(m)
      end do
	  end subroutine ckn2o_36
! *********************************************************************
!     o3 695--710 cm^{-1}
      subroutine cko3_36(u,f,p,t,tau)
	
		real, dimension(:), intent(in) :: p, t, u
		
		real, dimension(:), intent(inout) :: f
		real, dimension(:,:), intent(inout) :: tau
		
		
		real :: k(no3)
		integer :: i, m 
      f(1)=1.00000
      do  m=1,use_layers
          k(1)=53.867427*(1.0000-2.3299e-03*(t(m)-250.0)+ &
     &          1.2759e-05*(t(m)-250.0)**2)
          tau(1,m)=k(1)*u(m)
      end do
	  end subroutine cko3_36
!**********************************************************************
      subroutine window_36(omega,u,twin,pres,temp,fac)
		real, intent(in) :: omega, u, pres, temp, fac
		real, intent(inout) :: twin
		
		real :: r, amnt, a1, a2, ph2o, tau 
      r=8.314d+07
!     amnt=u/6.023e+23*2.687e+19*18.01534
      amnt=u
!     write(6,*)u,amnt
!     a1=4.18+5577.8*exp(-.00787*omega)
      a1=4.18+7815.6*exp(-.0083*omega)
      a1=a1*exp(1800.*(1./temp-1./296.))
      a2=0.0008*a1
      ph2o=amnt/(fac*1.0d+05)*r*temp/18.01534/1.01325d+06
      tau=amnt*(a1*ph2o+a2*(pres-ph2o))
!     tau=amnt*(a1*ph2o)
      if(tau.gt.88)then
      twin=88.0
      else
      twin=tau
      end if
	end subroutine window_36
	
end module modis36
