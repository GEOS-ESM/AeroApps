module modis34

	use CKD_common

	implicit none
	private
	
	integer, parameter :: ni = 5
	integer, parameter :: nco2 = 5
	integer, parameter :: no3 = 1
	
	public :: ch34, init_ch34
	
contains
	subroutine init_ch34(modis_channel)
	
		type(ckd_type), intent(inout) :: modis_channel
		integer :: all_weights
		
		all_weights = ni*nco2*no3 
		
		modis_channel%num_weights = all_weights
		allocate(modis_channel%weights(all_weights))
		allocate(modis_channel%taus(all_weights, max_layers))
	
	end subroutine init_ch34

      subroutine ch34(u0, p0, t0, ux, fac, u_co2, modis_channel)
!
!      This routine was developed for MODIS Channel 34: 725--740 cm^{-1}
!
!-----------------------------------------------------------------
!     Channel 34   13.49 - 13.78 microns
!-----------------------------------------------------------------
!  INPUTS:
!     u0 --> water vapor amount [g/cm2/km]
!     p0 --> pressure in atmospheres
!     t0 --> temp in K
!	  ux --> ozone (g/cm^2/km)
!     fac --> layer thickness in km
!-----------------------------------------------------------------

		real, dimension(:), intent(in) :: u0, p0, t0, ux, fac
		real, intent(in) :: u_co2
		type(ckd_type), intent(inout) :: modis_channel
		
		integer, parameter :: nlev = max_levels
		integer, parameter :: nlay = max_layers
		integer, parameter :: mlv = nlay

		real :: p(nlay), t(nlay),u(nlay), &
				 uco2(nlay), uo3(nlay)
				
		real :: tau(ni,nlay),tauco2(nco2,nlay), tauo3(no3, nlay), &
				f(ni), fco2(nco2), fo3(no3),  xlog, twin
		
		integer :: i,m,ia,ib, index
	
		real, parameter :: omega=732.5

	  
      do  m=1,use_layers
        t(m)=(t0(m)+t0(m+1))/2.0
        xlog=(log10(p0(m))+log10(p0(m+1)))/2.0
        p(m)=10.0**xlog
        xlog=(log10(u0(m))+log10(u0(m+1)))/2.0
        u(m)=fac(m)*10.0**xlog
        xlog=(log10(ux(m))+log10(ux(m+1)))/2.0
        uo3(m)=fac(m)*10.0**xlog
        uco2(m)=p(m)*1.01325e+06/(1.3805e-16*t(m))*u_co2*fac(m)*  &
     &          1.0e+05/6.023e+23*44.00995
       enddo

      call ck_34(u,f,p,t,tau)
      call ckco2_34(uco2,fco2,p,t,tauco2)
      call cko3_34(uo3,fo3,p,t,tauo3)
	  
      do  m=1,use_layers
        call window_34(omega,u(m),twin,p(m),t(m),fac(m))
         do ia=1,nco2 ! 5k's for co2
        do i=1,ni     ! 5k's for h2o
			index = (ia-1)*ni + i 
           modis_channel%taus(index,m)=tau(i,m)+twin+tauco2(ia,m)+tauo3(1,m)
 			if (m == 1) modis_channel%weights(index) = f(i)*fco2(ia)*fo3(1)
         end do
        end do
      enddo
  
      end subroutine ch34

! *********************************************************************
!     h2o 725--740 cm^{-1}
      subroutine ck_34(u,f,p,t,tau)
		real, dimension(:), intent(in) :: p, t, u
		
		real, dimension(:), intent(inout) :: f
		real, dimension(:,:), intent(inout) :: tau
		

		real :: k(ni)
		real :: coefk(ni,3,num_pressures)
		integer :: i, jp, jt
      f(1)=0.566373
      f(2)=0.287734
      f(3)=0.090240
      f(4)=0.041791
      f(5)=0.013862
      k(1)=0.003210092
      do i=2,ni
        k(i)=8.0*k(i-1)
      end do
      data ( (coefk(1,jt,jp), jp = 1, 19), jt = 1, 3)/  &
     & 0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,  &
     & 0.00000,0.00000,0.00000,0.00000,0.00039,0.00192,  &
     & 0.00553,0.01750,0.10309,0.31093,0.71903,1.35901,  &
     & 2.20650,  &
     & 0.000e+00,0.000e+00,0.000e+00,0.000e+00,0.000e+00,0.000e+00,  &
     & 0.000e+00,0.000e+00,0.000e+00,0.000e+00,1.239e-05,6.677e-05,  &
     & 1.712e-04,5.324e-04,2.222e-03,6.478e-03,1.459e-02,2.790e-02,  &
     & 4.630e-02,  &
     & 0.000e+00,0.000e+00,0.000e+00,0.000e+00,0.000e+00,0.000e+00,  &
     & 0.000e+00,0.000e+00,0.000e+00,0.000e+00,1.166e-07,7.556e-07,  &
     & 1.831e-06,5.666e-06,1.717e-05,4.735e-05,1.061e-04,2.014e-04,  &
     & 3.540e-04/
      data ( (coefk(2,jt,jp), jp = 1, 19), jt = 1, 3)/  &
     & 0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,  &
     & 0.00000,0.00009,0.00074,0.00256,0.00801,0.02699,  &
     & 0.09735,0.21324,0.35059,0.54320,0.82509,1.24155,  &
     & 1.91898,  &
     & 0.000e+00,0.000e+00,0.000e+00,0.000e+00,0.000e+00,0.000e+00,  &
     & 0.000e+00,2.838e-06,2.370e-05,7.469e-05,2.454e-04,6.821e-04,  &
     & 1.794e-03,3.912e-03,6.667e-03,1.007e-02,1.542e-02,2.255e-02,  &
     & 3.296e-02,  &
     & 0.000e+00,0.000e+00,0.000e+00,0.000e+00,0.000e+00,0.000e+00,  &
     & 0.000e+00,2.656e-08,2.556e-07,7.578e-07,2.672e-06,7.359e-06,  &
     & 1.232e-05,2.528e-05,4.626e-05,7.148e-05,1.116e-04,1.606e-04,  &
     & 2.058e-04/
      data ( (coefk(3,jt,jp), jp = 1, 19), jt = 1, 3)/  &
     & 0.00000,0.00000,0.00000,0.00000,0.00000,0.00008,  &
     & 0.00049,0.00183,0.00789,0.02739,0.05992,0.10554,  &
     & 0.16192,0.24217,0.36031,0.53060,0.80877,1.24927,  &
     & 1.82426,  &
     & 0.000e+00,0.000e+00,0.000e+00,0.000e+00,0.000e+00,2.963e-06,  &
     & 1.477e-05,5.024e-05,2.351e-04,6.521e-04,1.230e-03,2.022e-03,  &
     & 3.079e-03,4.576e-03,6.623e-03,9.341e-03,1.377e-02,2.099e-02,  &
     & 3.107e-02,  &
     & 0.000e+00,0.000e+00,0.000e+00,0.000e+00,0.000e+00,3.219e-08,  &
     & 1.625e-07,4.728e-07,2.459e-06,5.834e-06,9.584e-06,1.443e-05,  &
     & 2.180e-05,3.362e-05,4.794e-05,6.053e-05,7.671e-05,1.175e-04,  &
     & 2.064e-04/
      data ( (coefk(4,jt,jp), jp = 1, 19), jt = 1, 3)/  &
     & 0.00000,0.00000,0.00005,0.00026,0.00118,0.00480,  &
     & 0.01207,0.02357,0.03962,0.05968,0.08853,0.12911,  &
     & 0.18996,0.28531,0.42250,0.60611,0.86469,1.14154,  &
     & 1.38806,  &
     & 0.000e+00,0.000e+00,1.663e-06,7.325e-06,4.451e-05,1.404e-04,  &
     & 2.904e-04,5.019e-04,7.956e-04,1.177e-03,1.667e-03,2.359e-03,  &
     & 3.354e-03,4.805e-03,7.113e-03,1.012e-02,1.387e-02,1.787e-02,  &
     & 2.065e-02,  &
     & 0.000e+00,0.000e+00,1.719e-08,6.688e-08,5.241e-07,1.416e-06,  &
     & 2.503e-06,3.759e-06,5.672e-06,8.844e-06,1.175e-05,1.591e-05,  &
     & 2.045e-05,2.461e-05,4.050e-05,6.397e-05,7.605e-05,8.572e-05,  &
     & 7.081e-05/
      data ( (coefk(5,jt,jp), jp = 1, 19), jt = 1, 3)/  &
     & 1.12558,1.12843,1.13502,1.14548,1.16198,1.18519,  &
     & 1.21793,1.26279,1.32039,1.38187,1.43345,1.45970,  &
     & 1.44744,1.40259,1.33532,1.21621,1.08136,0.92873,  &
     & 0.74323,  &
     & 2.241e-02,2.239e-02,2.237e-02,2.237e-02,2.236e-02,2.232e-02,  &
     & 2.227e-02,2.221e-02,2.211e-02,2.203e-02,2.189e-02,2.170e-02,  &
     & 2.130e-02,2.060e-02,1.945e-02,1.736e-02,1.565e-02,1.331e-02,  &
     & 1.072e-02,  &
     & 1.382e-04,1.376e-04,1.366e-04,1.357e-04,1.334e-04,1.304e-04,  &
     & 1.261e-04,1.201e-04,1.115e-04,1.029e-04,9.261e-05,8.464e-05,  &
     & 8.134e-05,7.851e-05,6.963e-05,5.540e-05,5.173e-05,4.340e-05,  &
     & 3.720e-05/
		call apply_ckd(ni, k, u, f, p, t, tau, coefk, .false.)

      end subroutine ck_34
! *********************************************************************
!     co2 725--740 cm^{-1}
      subroutine ckco2_34(u,f,p,t,tau)
		real, dimension(:), intent(in) :: p, t, u
		
		real, dimension(:), intent(inout) :: f
		real, dimension(:,:), intent(inout) :: tau
		

		real :: k(nco2)
		real :: coefk(nco2,3,num_pressures)
		integer :: i, jp, jt
      f(1)=0.564236
      f(2)=0.305548
      f(3)=0.080665
      f(4)=0.034374
      f(5)=0.015177
      k(1)=0.438103
      do i=2,nco2
        k(i)=6.0*k(i-1)
      end do
      data ( (coefk(1,jt,jp), jp = 1, 19), jt = 1, 3)/  &
     & 0.00000,0.00000,0.00000,0.00012,0.00039,0.00124,  &
     & 0.00342,0.00874,0.02431,0.08244,0.19198,0.36602,  &
     & 0.63781,1.00000,1.56928,2.41471,3.65179,5.41087,  &
     & 8.02596,  &
     & 0.000e+00,0.000e+00,0.000e+00,4.938e-06,1.736e-05,5.256e-05,  &
     & 1.308e-04,3.084e-04,7.362e-04,1.727e-03,3.477e-03,6.335e-03,  &
     & 1.068e-02,1.660e-02,2.540e-02,3.707e-02,5.405e-02,7.705e-02,  &
     & 1.076e-01,  &
     & 0.000e+00,0.000e+00,0.000e+00,6.531e-08,2.416e-07,7.047e-07,  &
     & 1.650e-06,3.703e-06,8.281e-06,1.497e-05,2.417e-05,3.973e-05,  &
     & 5.874e-05,9.832e-05,1.456e-04,1.915e-04,2.546e-04,3.400e-04,  &
     & 3.966e-04/
      data ( (coefk(2,jt,jp), jp = 1, 19), jt = 1, 3)/  &
     & 0.00040,0.00071,0.00125,0.00222,0.00409,0.00954,  &
     & 0.02619,0.05823,0.11059,0.18498,0.29400,0.45389,  &
     & 0.68546,1.00000,1.38774,1.94128,2.79593,4.03266,  &
     & 5.50779,  &
     & 2.360e-05,3.439e-05,5.483e-05,9.295e-05,1.611e-04,3.316e-04,  &
     & 6.759e-04,1.265e-03,2.195e-03,3.530e-03,5.588e-03,8.408e-03,  &
     & 1.192e-02,1.673e-02,2.240e-02,2.829e-02,3.647e-02,4.931e-02,  &
     & 6.802e-02,  &
     & 3.781e-07,4.997e-07,7.669e-07,1.295e-06,2.172e-06,4.191e-06,  &
     & 7.084e-06,1.078e-05,1.623e-05,2.391e-05,3.915e-05,5.987e-05,  &
     & 7.721e-05,9.501e-05,1.286e-04,1.382e-04,1.271e-04,1.114e-04,  &
     & 1.334e-04/
      data ( (coefk(3,jt,jp), jp = 1, 19), jt = 1, 3)/  &
     & 0.00351,0.00464,0.00670,0.01200,0.02122,0.03675,  &
     & 0.05939,0.09402,0.14754,0.23257,0.35833,0.52047,  &
     & 0.70975,1.00000,1.48151,2.14685,2.84244,3.23002,  &
     & 3.11551,  &
     & 1.632e-04,1.854e-04,2.419e-04,3.755e-04,5.591e-04,8.329e-04,  &
     & 1.274e-03,1.963e-03,2.955e-03,4.208e-03,6.018e-03,8.441e-03,  &
     & 1.123e-02,1.348e-02,1.727e-02,2.458e-02,3.439e-02,4.224e-02,  &
     & 4.422e-02,  &
     & 2.364e-06,2.428e-06,2.978e-06,4.406e-06,5.728e-06,7.209e-06,  &
     & 9.984e-06,1.555e-05,2.396e-05,2.964e-05,3.533e-05,4.247e-05,  &
     & 6.512e-05,6.017e-05,3.348e-05,2.625e-05,4.775e-05,8.387e-05,  &
     & 1.198e-04/
      data ( (coefk(4,jt,jp), jp = 1, 19), jt = 1, 3)/  &
     & 0.01253,0.01435,0.01633,0.01948,0.02572,0.03681,  &
     & 0.05651,0.08996,0.13869,0.20420,0.30100,0.45874,  &
     & 0.70256,1.00000,1.25337,1.33949,1.22257,0.98584,  &
     & 0.73180,  &
     & 4.523e-04,4.591e-04,4.959e-04,5.622e-04,6.839e-04,8.828e-04,  &
     & 1.206e-03,1.673e-03,2.357e-03,3.276e-03,4.249e-03,5.547e-03,  &
     & 7.752e-03,1.144e-02,1.544e-02,1.790e-02,1.773e-02,1.523e-02,  &
     & 1.185e-02,  &
     & 5.438e-06,5.347e-06,5.884e-06,6.825e-06,7.978e-06,9.688e-06,  &
     & 1.169e-05,1.307e-05,1.487e-05,1.999e-05,2.185e-05,1.772e-05,  &
     & 6.506e-06,1.015e-05,2.193e-05,3.812e-05,5.011e-05,5.300e-05,  &
     & 4.844e-05/
      data ( (coefk(5,jt,jp), jp = 1, 19), jt = 1, 3)/  &
     & 0.80365,0.71084,0.64657,0.62277,0.64217,0.70352,  &
     & 0.80284,0.92969,1.06951,1.20198,1.28397,1.28417,  &
     & 1.18472,1.00000,0.77862,0.56393,0.38852,0.26111,  &
     & 0.17342,  &
     & 9.956e-03,9.192e-03,8.903e-03,9.089e-03,9.706e-03,1.068e-02,  &
     & 1.193e-02,1.336e-02,1.477e-02,1.614e-02,1.751e-02,1.794e-02,  &
     & 1.709e-02,1.507e-02,1.220e-02,9.155e-03,6.462e-03,4.368e-03,  &
     & 2.909e-03,  &
     & 3.728e-05,4.354e-05,4.976e-05,5.441e-05,5.657e-05,5.687e-05,  &
     & 5.470e-05,5.178e-05,4.843e-05,4.266e-05,4.663e-05,4.977e-05,  &
     & 5.037e-05,5.139e-05,4.547e-05,3.740e-05,2.907e-05,2.004e-05,  &
     & 1.354e-05/
		call apply_ckd(nco2, k, u, f, p, t, tau, coefk, .false.)
      end subroutine ckco2_34
! *********************************************************************
!     o3 725--740 cm^{-1}
      subroutine cko3_34(u,f,p,t,tau)
	
		real, dimension(:), intent(in) :: p, t, u
		
		real, dimension(:), intent(inout) :: f
		real, dimension(:,:), intent(inout) :: tau
		
		
		real :: k(no3)
		integer :: i, m 
      f(1)=1.00000
      do  m=1,use_layers
          k(1)=61.04513*(1.0000+1.0339e-03*(t(m)-250.0)+  &
     &          4.2656e-06*(t(m)-250.0)**2)
          tau(1,m)=k(1)*u(m)
      end do
	  end subroutine cko3_34
!**********************************************************************
      subroutine window_34(omega,u,twin,pres,temp,fac)
		real, intent(in) :: omega, u, pres, temp, fac
		real, intent(inout) :: twin
		
		real :: r, amnt, a1, a2, ph2o, tau 
      r=8.314d+07
!     amnt=u/6.023e+23*2.687e+19*18.01534
      amnt=u
!     write(6,*)u,amnt
!     a1=4.18+5577.8*exp(-.00787*omega)
      a1=4.18+7815.6*exp(-.0083*omega)
      a1=a1*exp(1800.*(1./temp-1./296.))
      a2=0.0008*a1
      ph2o=amnt/(fac*1.0d+05)*r*temp/18.01534/1.01325d+06
      tau=amnt*(a1*ph2o+a2*(pres-ph2o))
!     tau=amnt*(a1*ph2o)
      if(tau.gt.88)then
      twin=88.0
      else
      twin=tau
      end if
	end subroutine window_34
	
end module modis34
